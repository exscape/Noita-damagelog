dofile_once("mods/damagelog-dev-helper/files/utils.lua")
local nxml = dofile_once("mods/damagelog-dev-helper/files/nxml.lua")

--[[
	Because (AFAIK) neither Noita nor Lua has the ability to query the filesystem, and
	getting LuaRocks + LuaFileSystem installed seems a massive pain, I decided to just not bother,
	and use a separate tool to gather the list of files.

	The reason this utility is a Noita mod to begin with is that Noita XML is not actual XML, so
	you need special tools to parse it the way the game does.
	I use the included "nxml" library for this.

	If it wasn't for the nxml requirement, this would have been a 100% python solution instead.

	To generate the following line, I used the following in WSL:
	echo 'local file_list = {' $(find data/entities/animals -iname '*.xml' | sed -e 's#.*entities/animals/##g' | sort | sed -e 's#^#"#g' -e 's#$#",#g') '}' | clip.exe
	It's simply a list of all xml files under data/entities/animals, with the common prefix stripped to avoid repetition.
]]
-- Generated 2024-04-14, but on Noita's 20241801-1725 build (on GOG).
local file_list = { "acidshooter_weak.xml", "acidshooter.xml", "alchemist.xml", "ant.xml", "apparition/playerghost.xml", "assassin.xml", "barfer.xml", "basebot_hidden.xml", "basebot_neutralizer.xml", "basebot_sentry.xml", "basebot_soldier.xml", "bat.xml", "berserkspirit.xml", "bigbat.xml", "bigfirebug.xml", "bigzombiehead.xml", "bigzombietorso.xml", "bigzombie.xml", "blob.xml", "bloodcrystal_physics.xml", "bloom.xml", "boss_alchemist/boss_alchemist_sprite.xml", "boss_alchemist/boss_alchemist.xml", "boss_alchemist/countered_projectile_effect.xml", "boss_alchemist/enlightened_alchemist_boss.xml", "boss_alchemist/key_particles_first_alt.xml", "boss_alchemist/key_particles_first.xml", "boss_alchemist/key_particles_second_alt.xml", "boss_alchemist/key_particles_second.xml", "boss_alchemist/key.xml", "boss_alchemist/projectile_counter.xml", "boss_alchemist/wand_orb.xml", "boss_book/book_physics.xml", "boss_centipede/body_chunks.xml", "boss_centipede/body.xml", "boss_centipede/boss_centipede_explosion_effect.xml", "boss_centipede/boss_centipede_explosion_large.xml", "boss_centipede/boss_centipede_explosion.xml", "boss_centipede/boss_centipede_minion.xml", "boss_centipede/boss_centipede_shield_strong.xml", "boss_centipede/boss_centipede_shield_trail_effect.xml", "boss_centipede/boss_centipede_shield_weak.xml", "boss_centipede/boss_centipede.xml", "boss_centipede/boss_music_buildup_trigger.xml", "boss_centipede/boss_victoryroom_ambience.xml", "boss_centipede/boss_victoryroom_mechanism_sprite.xml", "boss_centipede/boss_victoryroom_mechanism.xml", "boss_centipede/bug_blue.xml", "boss_centipede/clear_materials_image.xml", "boss_centipede/clear_materials.xml", "boss_centipede/ending/ending_sampo_spot_mountain.xml", "boss_centipede/ending/ending_sampo_spot_underground.xml", "boss_centipede/ending/gold_effect.xml", "boss_centipede/ending/midas_chunks.xml", "boss_centipede/ending/midas_entities.xml", "boss_centipede/ending/midas_radioactive.xml", "boss_centipede/ending/midas_sand.xml", "boss_centipede/ending/midas_walls.xml", "boss_centipede/ending/midas.xml", "boss_centipede/ending/sampo_effect.xml", "boss_centipede/firepillar_part.xml", "boss_centipede/firepillar.xml", "boss_centipede/limbs/limb_long_a_green.xml", "boss_centipede/limbs/limb_long_a.xml", "boss_centipede/limbs/limb_long_b_green.xml", "boss_centipede/limbs/limb_long_b.xml", "boss_centipede/limbs/limb_long_knee_green.xml", "boss_centipede/limbs/limb_long_knee.xml", "boss_centipede/limbs/limb_long.xml", "boss_centipede/loose_lavabridge.xml", "boss_centipede/loose_lavaceiling.xml", "boss_centipede/melee.xml", "boss_centipede/minion_physics_eye.xml", "boss_centipede/minion_physics_particle.xml", "boss_centipede/orb_circleshot.xml", "boss_centipede/orb_homing_part.xml", "boss_centipede/orb_homing.xml", "boss_centipede/orb_mat_blood_gfx.xml", "boss_centipede/orb_mat_blood.xml", "boss_centipede/orb_mat_lava_gfx.xml", "boss_centipede/orb_mat_lava.xml", "boss_centipede/orb_mat_oil_gfx.xml", "boss_centipede/orb_mat_oil.xml", "boss_centipede/orb_mat_radioactive_gfx.xml", "boss_centipede/orb_mat_radioactive.xml", "boss_centipede/orb_polymorph.xml", "boss_centipede/orb_purple.xml", "boss_centipede/reference_point.xml", "boss_centipede/rewards/giant_dollar.xml", "boss_centipede/rewards/gold_reward.xml", "boss_centipede/rewards/reward_almostpacifist.xml", "boss_centipede/rewards/reward_clock.xml", "boss_centipede/rewards/reward_crown.xml", "boss_centipede/rewards/reward_dollar.xml", "boss_centipede/rewards/reward_kicksonly.xml", "boss_centipede/rewards/reward_minit.xml", "boss_centipede/rewards/reward_nohit.xml", "boss_centipede/rewards/reward_nolla.xml", "boss_centipede/rewards/reward_notinkeringofwands.xml", "boss_centipede/rewards/reward_nowands.xml", "boss_centipede/rewards/reward_peace.xml", "boss_centipede/rewards/reward_sun.xml", "boss_centipede/sampo_sprite.xml", "boss_centipede/sampo_working_sprite.xml", "boss_centipede/sampo_working.xml", "boss_centipede/sampo.xml", "boss_centipede/tail/tail_1_green.xml", "boss_centipede/tail/tail_1.xml", "boss_centipede/tail/tail_2_green.xml", "boss_centipede/tail/tail_2.xml", "boss_centipede/tail/tail_verlet_1.xml", "boss_centipede/tail/tail_verlet_2.xml", "boss_centipede/tail/tail.xml", "boss_centipede/verlet_chains/minion_tentacle_1.xml", "boss_centipede/verlet_chains/minion_tentacle_2.xml", "boss_centipede/verlet_chains/minion_tentacle_3.xml", "boss_centipede/verlet_chains/minion_tentacle_4.xml", "boss_centipede/verlet_chains/minion_tentacle_verlet_1.xml", "boss_centipede/verlet_chains/minion_tentacle_verlet_2.xml", "boss_centipede/verlet_chains/minion_tentacle_verlet_3.xml", "boss_centipede/verlet_chains/minion_tentacle_verlet_4.xml", "boss_centipede/verlet_chains/minion_tentacle.xml", "boss_centipede/verlet_chains/verlet_1_green.xml", "boss_centipede/verlet_chains/verlet_1.xml", "boss_centipede/verlet_chains/verlet_2_green.xml", "boss_centipede/verlet_chains/verlet_2.xml", "boss_centipede/verlet_chains/verlet_3_green.xml", "boss_centipede/verlet_chains/verlet_3.xml", "boss_centipede/verlet_chains/verlet_4_green.xml", "boss_centipede/verlet_chains/verlet_4.xml", "boss_centipede/verlet_chains/verlet_vine_long.xml", "boss_centipede/verlet_chains/verlet_vine_short.xml", "boss_centipede/verlet_chains/verlet_vine.xml", "boss_centipede/verlet_chains/vine_verlet_1.xml", "boss_centipede/verlet_chains/vine_verlet_2.xml", "boss_centipede/verlet_chains/vine_verlet_3.xml", "boss_centipede/verlet_chains/vine_verlet_4.xml", "boss_centipede/verlet_cord.xml", "boss_dragon.xml", "boss_fish/eye.xml", "boss_fish/fish_giga.xml", "boss_fish/orb_big_sprite.xml", "boss_fish/orb_big.xml", "boss_gate/gate_monster_a_glow.xml", "boss_gate/gate_monster_a.xml", "boss_gate/gate_monster_b_glow.xml", "boss_gate/gate_monster_b.xml", "boss_gate/gate_monster_c_glow.xml", "boss_gate/gate_monster_c.xml", "boss_gate/gate_monster_d_glow.xml", "boss_gate/gate_monster_d.xml", "boss_ghost/body.xml", "boss_ghost/boss_ghost_polyp.xml", "boss_ghost/boss_ghost.xml", "boss_ghost/eye.xml", "boss_ghost/ghost_spawn_check.xml", "boss_ghost/polyp_eye.xml", "boss_ghost/polyp.xml", "boss_ghost/pupil.xml", "boss_limbs/body.xml", "boss_limbs/boss_limbs_physics.xml", "boss_limbs/boss_limbs_trigger.xml", "boss_limbs/boss_limbs.xml", "boss_limbs/eyea.xml", "boss_limbs/eyeb.xml", "boss_limbs/hair1.xml", "boss_limbs/hair2.xml", "boss_limbs/hair3.xml", "boss_limbs/hair_piece_thin.xml", "boss_limbs/hair_piece.xml", "boss_limbs/limb_attacker.xml", "boss_limbs/limb_enemy_generic.xml", "boss_limbs/limb.xml", "boss_limbs/orb_boss_limbs.xml", "boss_limbs/orb_pink_big.xml", "boss_limbs/skull.xml", "boss_limbs/slime_boss_limbs.xml", "boss_limbs/slimeshooter_boss_limbs.xml", "boss_limbs/slimeshooter_boss.xml", "boss_meat/acidshot_slow.xml", "boss_meat/body.xml", "boss_meat/boss_meat.xml", "boss_meat/hair1.xml", "boss_meat/hair2.xml", "boss_meat/hair3.xml", "boss_meat/hair_piece_thin.xml", "boss_meat/hair_piece.xml", "boss_meat/knee.xml", "boss_meat/limb_a.xml", "boss_meat/limb_b.xml", "boss_meat/limb.xml", "boss_meat/orb_big.xml", "boss_meat/slime_boss_limbs.xml", "boss_pit/body.xml", "boss_pit/boss_pit_spawner.xml", "boss_pit/boss_pit.xml", "boss_pit/tentacle_1.xml", "boss_pit/tentacle_2.xml", "boss_pit/tentacle_3.xml", "boss_pit/tentacle_4.xml", "boss_pit/tentacle_verlet_1.xml", "boss_pit/tentacle_verlet_2.xml", "boss_pit/tentacle_verlet_3.xml", "boss_pit/tentacle_verlet_4.xml", "boss_pit/tentacle.xml", "boss_pit/wand.xml", "boss_robot/body.xml", "boss_robot/boss_robot.xml", "boss_robot/limb.xml", "boss_robot/rocket_roll.xml", "boss_robot/rocket.xml", "boss_spirit/boss_spirit_sprite.xml", "boss_spirit/countered_projectile_effect.xml", "boss_spirit/islandspirit.xml", "boss_spirit/orb.xml", "boss_spirit/spawner.xml", "boss_spirit/spawn_portal.xml", "boss_spirit/wisp.xml", "boss_wizard/bloodtentacle.xml", "boss_wizard/boss_wizard.xml", "boss_wizard/debuff_init.xml", "boss_wizard/debuff.xml", "boss_wizard/laser.xml", "boss_wizard/meteor.xml", "boss_wizard/orb_blood.xml", "boss_wizard/orb_death.xml", "boss_wizard/spawner.xml", "boss_wizard/statusburst.xml", "boss_wizard/summon.xml", "boss_wizard/wizard_body.xml", "boss_wizard/wizard_hand.xml", "boss_wizard/wizard_head.xml", "boss_wizard/wizard_helmet.xml", "boss_wizard/wizard_orb_blood.xml", "boss_wizard/wizard_orb_death.xml", "chest_leggy.xml", "chest_mimic.xml", "confusespirit.xml", "coward.xml", "crypt/acidshooter.xml", "crypt/barfer.xml", "crypt/crystal_physics.xml", "crypt/enlightened_alchemist.xml", "crypt/failed_alchemist.xml", "crypt/maggot.xml", "crypt/necromancer.xml", "crypt/phantom_a.xml", "crypt/phantom_b.xml", "crypt/skullfly.xml", "crypt/skullrat.xml", "crypt/tentacler_small.xml", "crypt/tentacler.xml", "crypt/thundermage.xml", "crypt/wizard_dark.xml", "crypt/wizard_neutral.xml", "crypt/wizard_poly.xml", "crypt/wizard_returner.xml", "crypt/wizard_tele.xml", "crypt/worm_skull.xml", "crypt/worm.xml", "crystal_physics.xml", "darkghost.xml", "deer.xml", "drone_lasership.xml", "drone_physics.xml", "drone_shield.xml", "drone.xml", "drunk/miner_chef.xml", "drunk/miner_fire.xml", "drunk/miner_weak.xml", "drunk/miner.xml", "drunk/scavenger_clusterbomb.xml", "drunk/scavenger_glue.xml", "drunk/scavenger_grenade.xml", "drunk/scavenger_heal.xml", "drunk/scavenger_invis.xml", "drunk/scavenger_leader.xml", "drunk/scavenger_mine.xml", "drunk/scavenger_poison.xml", "drunk/scavenger_shield.xml", "drunk/scavenger_smg.xml", "drunk/shotgunner_weak.xml", "drunk/shotgunner.xml", "drunk/sniper.xml", "duck.xml", "easter/sniper.xml", "eel.xml", "elk.xml", "ending_placeholder/boss_dragon_endcrystal.xml", "ending_placeholder/boss_limbs/body.xml", "ending_placeholder/boss_limbs/boss_limbs_physics.xml", "ending_placeholder/boss_limbs/boss_limbs.xml", "ending_placeholder/boss_limbs/eyea.xml", "ending_placeholder/boss_limbs/eyeb.xml", "ending_placeholder/boss_limbs/hair1.xml", "ending_placeholder/boss_limbs/hair2.xml", "ending_placeholder/boss_limbs/hair3.xml", "ending_placeholder/boss_limbs/hair_piece_thin.xml", "ending_placeholder/boss_limbs/hair_piece.xml", "ending_placeholder/boss_limbs/limb_attacker.xml", "ending_placeholder/boss_limbs/limb_enemy_generic.xml", "ending_placeholder/boss_limbs/limb.xml", "ending_placeholder/boss_limbs/orb_boss_limbs.xml", "ending_placeholder/boss_limbs/skull.xml", "ending_placeholder/boss_limbs/slime_boss_limbs.xml", "ending_placeholder/boss_limbs/slimeshooter_boss_limbs.xml", "ending_placeholder/boss_limbs/slimeshooter_boss.xml", "enlightened_alchemist.xml", "ethereal_being.xml", "failed_alchemist_b.xml", "failed_alchemist.xml", "firebug.xml", "firemage_weak.xml", "firemage.xml", "fireskull_weak.xml", "fireskull.xml", "fish_large.xml", "fish.xml", "flamer.xml", "fly.xml", "friend.xml", "frog_big.xml", "frog.xml", "fungus_big.xml", "fungus_giga.xml", "fungus_tiny.xml", "fungus.xml", "gazer.xml", "ghost.xml", "ghoul.xml", "giantshooter_weak.xml", "giantshooter.xml", "giant.xml", "goblin_bomb.xml", "healerdrone_physics.xml", "icemage.xml", "icer.xml", "iceskull.xml", "illusions/acidshooter.xml", "illusions/dark_alchemist.xml", "illusions/enlightened_alchemist.xml", "illusions/scavenger_grenade.xml", "illusions/scavenger_mine.xml", "illusions/shaman_wind.xml", "illusions/shaman.xml", "illusions/tank.xml", "illusions/tentacler.xml", "illusions/thundermage.xml", "illusions/wizard_swapper.xml", "illusions/worm_big.xml", "lasershooter.xml", "longleg.xml", "lukki/lukki_creepy_long.xml", "lukki/lukki_creepy.xml", "lukki/lukki_dark.xml", "lukki/lukki_feet/chest_limb_attacker.xml", "lukki/lukki_feet/chest_limb_left.xml", "lukki/lukki_feet/chest_limb_right.xml", "lukki/lukki_feet/chest_limb.xml", "lukki/lukki_feet/lukki_dark_limb_animated.xml", "lukki/lukki_feet/lukki_dark_sprite_emissive.xml", "lukki/lukki_feet/lukki_dark_sprite.xml", "lukki/lukki_feet/lukki_limb_animated.xml", "lukki/lukki_feet/lukki_limb_attacker_long2.xml", "lukki/lukki_feet/lukki_limb_attacker_long.xml", "lukki/lukki_feet/lukki_limb_attacker_minion.xml", "lukki/lukki_feet/lukki_limb_attacker_tiny.xml", "lukki/lukki_feet/lukki_limb_attacker.xml", "lukki/lukki_feet/lukki_limb_long2.xml", "lukki/lukki_feet/lukki_limb_long_animated.xml", "lukki/lukki_feet/lukki_limb_long.xml", "lukki/lukki_feet/lukki_limb_minion.xml", "lukki/lukki_feet/lukki_limb_tiny.xml", "lukki/lukki_feet/lukki_limb.xml", "lukki/lukki_feet/lukki_sprite_b.xml", "lukki/lukki_feet/lukki_sprite_creepy2.xml", "lukki/lukki_feet/lukki_sprite_creepy.xml", "lukki/lukki_feet/lukki_sprite_emissive_b.xml", "lukki/lukki_feet/lukki_sprite_emissive.xml", "lukki/lukki_feet/lukki_sprite_minion.xml", "lukki/lukki_feet/lukki_sprite_tiny.xml", "lukki/lukki_feet/lukki_sprite.xml", "lukki/lukki_feet/lukki_wiggle.xml", "lukki/lukki_longleg.xml", "lukki/lukki_tiny.xml", "lukki/lukki.xml", "lurker.xml", "maggot_tiny/maggot_tiny.xml", "maggot_tiny/orb.xml", "maggot.xml", "meatmaggot.xml", "mimic_physics.xml", "miner_chef.xml", "miner_fire.xml", "miner_hell.xml", "miner_santa.xml", "miner_weak.xml", "miner.xml", "miniblob.xml", "missilecrab.xml", "monk.xml", "necrobot_super.xml", "necrobot.xml", "necromancer_shop.xml", "necromancer_super.xml", "necromancer.xml", "parallel/alchemist/parallel_alchemist.xml", "parallel/alchemist/sprite.xml", "parallel/tentacles/parallel_tentacles.xml", "parallel/tentacles/sprite.xml", "parallel/tentacles/tentacle_1.xml", "parallel/tentacles/tentacle_2.xml", "parallel/tentacles/tentacle_3.xml", "parallel/tentacles/tentacle_4.xml", "parallel/tentacles/tentacle_verlet_1.xml", "parallel/tentacles/tentacle_verlet_2.xml", "parallel/tentacles/tentacle_verlet_3.xml", "parallel/tentacles/tentacle_verlet_4.xml", "parallel/tentacles/tentacle.xml", "pebble_physics.xml", "phantom_a.xml", "phantom_b.xml", "playerghost.xml", "rainforest/bloom.xml", "rainforest/coward.xml", "rainforest/flamer.xml", "rainforest/fly.xml", "rainforest/fungus.xml", "rainforest/scavenger_clusterbomb.xml", "rainforest/scavenger_grenade.xml", "rainforest/scavenger_heal.xml", "rainforest/scavenger_leader.xml", "rainforest/scavenger_mine.xml", "rainforest/scavenger_poison.xml", "rainforest/scavenger_smg.xml", "rainforest/shooterflower.xml", "rainforest/sniper.xml", "rat.xml", "robobase/drone_lasership.xml", "robobase/drone_shield.xml", "robobase/healerdrone_physics.xml", "robobase/monk.xml", "robobase/tank_super.xml", "robobase/turret_left.xml", "robobase/turret_right.xml", "roboguard_big.xml", "roboguard.xml", "scavenger_clusterbomb.xml", "scavenger_glue.xml", "scavenger_grenade.xml", "scavenger_heal.xml", "scavenger_invis.xml", "scavenger_leader.xml", "scavenger_mine.xml", "scavenger_poison.xml", "scavenger_shield.xml", "scavenger_smg.xml", "scorpion.xml", "shaman.xml", "sheep_bat.xml", "sheep_fly.xml", "sheep.xml", "shooterflower.xml", "shotgunner_hell.xml", "shotgunner_weak.xml", "shotgunner.xml", "skullfly.xml", "skullrat.xml", "skycrystal_physics.xml", "skygazer.xml", "slimeshooter_nontoxic.xml", "slimeshooter_weak.xml", "slimeshooter.xml", "slimespirit.xml", "sniper_hell.xml", "sniper.xml", "spearbot.xml", "special/minipit.xml", "special/verlet_chains/minion_tentacle_1.xml", "special/verlet_chains/minion_tentacle_2.xml", "special/verlet_chains/minion_tentacle_3.xml", "special/verlet_chains/minion_tentacle_4.xml", "special/verlet_chains/minion_tentacle_verlet_1.xml", "special/verlet_chains/minion_tentacle_verlet_2.xml", "special/verlet_chains/minion_tentacle_verlet_3.xml", "special/verlet_chains/minion_tentacle_verlet_4.xml", "special/verlet_chains/minion_tentacle.xml", "spitmonster.xml", "statue_physics.xml", "statue.xml", "tank_rocket.xml", "tank_super.xml", "tank.xml", "tentacler_small.xml", "tentacler.xml", "_test_walk.xml", "the_end/bloodcrystal_physics.xml", "the_end/gazer.xml", "the_end/skycrystal_physics.xml", "the_end/skygazer.xml", "the_end/spearbot.xml", "the_end/spitmonster.xml", "the_end/worm_end.xml", "the_end/worm_skull.xml", "thundermage_big.xml", "thundermage.xml", "thunderskull.xml", "turret_left.xml", "turret_right.xml", "ultimate_killer.xml", "vault/acidshooter.xml", "vault/assassin.xml", "vault/bigzombie.xml", "vault/blob.xml", "vault/coward.xml", "vault/drone_physics.xml", "vault/firemage.xml", "vault/flamer.xml", "vault/healerdrone_physics.xml", "vault/icer.xml", "vault/lasershooter.xml", "vault/maggot.xml", "vault/missilecrab.xml", "vault/roboguard.xml", "vault/scavenger_glue.xml", "vault/scavenger_grenade.xml", "vault/scavenger_heal.xml", "vault/scavenger_leader.xml", "vault/scavenger_mine.xml", "vault/scavenger_smg.xml", "vault/sniper.xml", "vault/tank_rocket.xml", "vault/tank_super.xml", "vault/tank.xml", "vault/tentacler_small.xml", "vault/tentacler.xml", "vault/thundermage.xml", "vault/thunderskull.xml", "vault/turret_left.xml", "vault/turret_right.xml", "vault/wizard_dark.xml", "wand_ghost_charmed.xml", "wand_ghost_with_sampo.xml", "wand_ghost.xml", "weakspirit.xml", "wizard_dark.xml", "wizard_hearty.xml", "wizard_homing.xml", "wizard_neutral.xml", "wizard_poly.xml", "wizard_returner.xml", "wizard_swapper.xml", "wizard_tele.xml", "wizard_twitchy.xml", "wizard_weaken.xml", "wolf.xml", "worm_big.xml", "worm_end.xml", "worm_skull.xml", "worm_tiny.xml", "worm.xml", "wraith_glowing.xml", "wraith_storm.xml", "wraith.xml", "zombie_weak.xml", "zombie.xml", }

-- Ugly but easy. 0 = not started, 1 = started, 2 = errored out, 3 = successfully completed
local status = 0

-- Only available in beta, I think
ModDoesFileExist = ModDoesFileExist or function(path) return ModTextFileGetContent(path) ~= nil end

-- Borrowed from grahamsdialogue mod with permission from authors (GrahamBurger and NathanSnail)
-- Thanks!
-- Reads an entity XML file and moves down to its base (and its base...) until a name is hopefully found
local function traverse_base_tree(file, is_recursing)
	if file:sub(1, 4) ~= "data" and file:sub(1, 4) ~= "mods" then return "" end -- the stupid api says bones exist but they can't be read.
	if not ModDoesFileExist(file) then return "" end
	local tree = nxml.parse(ModTextFileGetContent(file))
	local name = tree.attr.name
	if name ~= nil then
		if is_recursing and name:sub(1,8) == "$animal_" then
			return name
		else
			-- For this helper, we only want to print names that are *NOT* easily available in the game.
			-- If we found the name in the original file, i.e. we didn't need to access a <Base> file,
			-- EntityGetName() should work, and storing the mapping would be a waste of space and perhaps CPU time.
			return "__ignore__"
		end
	end
	for _, v in ipairs(tree.children) do
		if v.name == "Base" then
			return traverse_base_tree(v.attr.file, true)
		end
	end
	return ""
end

function OnModPostInit()
	log("Initializing damagelog-dev-helper; " .. tostring(#file_list) .. " files to process")

	local file_handle = io.open("mods/damagelog/files/additional_entities.lua", "w")

	if not file_handle then
		log("!!! Unable to open output file! Check path and permissions. Exiting!")
		status = 2
		return
	end

	file_handle:write("return {\n")
	status = 1

	for _, filename in ipairs(file_list) do
		local path = "data/entities/animals/" .. filename
		local name = traverse_base_tree(path, false)
		if #name > 0 and name ~= "__ignore__" then
			log(name .. " for " .. path)
			file_handle:write(string.format('    ["%s"] = "%s",\n', path, name))
		elseif name == "__ignore__" then
			log("Ignoring " .. path)
		else
			log("No name found for " .. path)
		end
	end

	file_handle:write("}\n")
	file_handle:close()
	status = 3

end

-- Ugly but easy. 0 = not started, 1 = started, 2 = errored out, 3 = successfully completed
function OnPlayerSpawned(player_entity)
	if status == 0 then
		log("processing hasn't started yet; check output folder (damagelog/files) soon...")
	elseif status == 1 then
		log("processing started but not completed yet; check output folder (damagelog/files) soon...")
	elseif status == 2 then
		log("processing failed!")
	else
		log("done processing entities! File is written and closed.")
	end
end